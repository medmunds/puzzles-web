---
apply: always
---

# AI Assistant Rules for puzzles-web

## Project Overview

This is a progressive web application (PWA) port of Simon Tatham's Portable Puzzle Collection. The project consists of:

- **C/C++ puzzle code** (in `/puzzles`) compiled to WebAssembly using Emscripten
  - Includes upstream puzzles + experimental puzzles from `/puzzles/unreleased`
- **TypeScript web app** (in `/src`) using Lit web components and Vite
- Target: Baseline 2023 browser compatibility (see `src/preflight.ts`)

## Code Style & Standards

### TypeScript/JavaScript

- **Formatter**: Biome (2-space indents, 88 char line width)
- **Linting**: Biome with recommended rules + strict promise handling
- **TypeScript**: Strict mode enabled with no unused locals/parameters
- Use `npm run check` to format and lint code
- Use `npm run build` to verify TypeScript compilation

### Code Conventions

- Use Lit web components for UI elements
- Use Web Awesome components where appropriate
  - Explicitly register components by importing them (e.g., `import "@awesome.me/webawesome/dist/components/button/button.js"`)
- Use @lit-labs/signals for reactive state management
  - Use `SignalWatcher` mixin for components that consume signals
- Store data in IndexedDB via Dexie.js
- Run WASM in web workers exposed via Comlink
- Apply Web Awesome design tokens for styling

### File Organization

- `/src/puzzle`: Reusable puzzle components (potentially extractable)
- `/src`: PWA-specific components and screens
- `/src/assets/icons` and `/src/assets/puzzles`: Generated by Docker builds (not in repo)
- `/help`: Main help pages
- `/functions`: Cloudflare Pages routing functions
- `/puzzles`: Upstream puzzles repository (git subtree)
- `/puzzles/unreleased`: Experimental puzzles from other authors (git subtree)

## Build Process

### Puzzles (C/C++ to WASM)

```bash
# Build icons
podman run --rm \
  -v ./puzzles:/app/puzzles:ro \
  -v ./src/assets:/app/assets \
  build-icons

# Build WASM
podman run --rm \
  -v ./puzzles:/app/puzzles:ro \
  -v ./src/assets:/app/assets \
  build-emcc
```

### Web App

- `npm run dev` - Development server
- `npm run build` - Production build (runs tsc + vite build)
- `npm run preview` - Preview production build
- `npm run check` - Format and lint

## Important Constraints

### DO NOT

- Modify files in `/puzzles` or `/puzzles/unreleased` without understanding upstream impact (these are git subtrees)
- Break Baseline 2023 browser compatibility
- Use top-level await, dynamic `import()`, or `import.meta` in `src/preflight.ts` (must support older browsers to perform checks)
- Add dependencies without considering bundle size and offline support
- Commit generated files in `/src/assets/icons` or `/src/assets/puzzles`
- Catch unrecoverable errors only to log them to the console (instead allow them to propagate for Sentry reporting)

### DO

- Test on touch devices and various screen sizes
- Ensure offline functionality works (PWA/service worker)
- Follow the existing patterns for web components
- Check that changes work with keyboard, mouse, and touch input (stylus/touch handled in frontend)
- Consider accessibility

## Testing

Note: There are currently no automated tests (version 0.0.1). Manual testing is required.

## Git Workflow

- Main branch: main
- Husky pre-commit hooks run `biome check`

## Special Files

- `webapp.cpp`: Frontend adapter between C puzzle code and TypeScript
- `puzzle.ts` and `worker.ts`: How frontend is exposed to TypeScript app
- `puzzle.html`: Single entry point for all puzzle pages
- `src/preflight.ts`: Browser capability checks for Baseline 2023 compatibility
- `src/store/db.ts`: Dexie.js database schema and configuration

Build process:
- `vite-puzzles-routing.ts`: Dynamic puzzle page routing
- `vite-extra-pages.ts`: Custom plugin for help system assembly

## Documentation

- Help system combines: `/help` pages + upstream `/puzzles/html` + generated manual
- Update help when adding features that differ from upstream

## License

- Web app code: MIT License
- Upstream puzzles code: MIT License (see puzzles/LICENCE)
