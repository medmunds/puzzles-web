/**
 * Typing and declaration for Emscripten's Module object.
 */

import type {
  ClassHandle,
  DrawingWrapper,
  MainModule,
  NotifyGameIdChange,
  NotifyGameStateChange,
  NotifyPresetIdChange,
  NotifyStatusBarChange,
  Point,
  Size,
} from "../assets/js/emcc-runtime";

import createModule from "../assets/js/emcc-runtime";

// (Re-export generated types so other code doesn't need to dig into assets.)
export type {
  Colour,
  Drawing,
  DrawingWrapper,
  DrawTextOptions,
  Frontend,
  NotifyGameIdChange,
  NotifyGameStateChange,
  NotifyPresetIdChange,
  NotifyStatusBarChange,
  KeyLabel,
  Point,
  PresetMenuEntry,
  Rect,
  Size,
} from "../assets/js/emcc-runtime";

export type ChangeNotification =
  | NotifyGameIdChange
  | NotifyGameStateChange
  | NotifyPresetIdChange
  | NotifyStatusBarChange;

// biome-ignore lint/style/useEnumInitializers: verbatim from puzzles.h
export enum PuzzleButton {
  LEFT_BUTTON = 0x0200,
  MIDDLE_BUTTON,
  RIGHT_BUTTON,
  LEFT_DRAG,
  MIDDLE_DRAG,
  RIGHT_DRAG,
  LEFT_RELEASE,
  MIDDLE_RELEASE,
  RIGHT_RELEASE,
  CURSOR_UP,
  CURSOR_DOWN,
  CURSOR_LEFT,
  CURSOR_RIGHT,
  CURSOR_SELECT,
  CURSOR_SELECT2,
  /* UI_* are special keystrokes generated by front ends in response
   * to menu actions, never passed to back ends */
  UI_LOWER_BOUND,
  UI_QUIT,
  UI_NEWGAME,
  UI_SOLVE,
  UI_UNDO,
  UI_REDO,
  UI_UPPER_BOUND,

  /* made smaller because of 'limited range of datatype' errors. */
  MOD_CTRL = 0x1000,
  MOD_SHFT = 0x2000,
  MOD_NUM_KEYPAD = 0x4000,
  MOD_MASK = 0x7000 /* mask for all modifiers */,
}

/**
 * Required JS_side implementation for Drawing API
 */
export interface DrawingImpl<Blitter = unknown>
  extends Omit<DrawingWrapper, keyof ClassHandle | "notifyOnDestruction">,
    Partial<Pick<DrawingWrapper, "notifyOnDestruction">> {
  // Redeclare blitter methods to improve typing
  blitterNew(size: Size): Blitter;
  blitterFree(blitter: Blitter): void;
  blitterSave(blitter: Blitter, origin: Point): void;
  blitterLoad(blitter: Blitter, origin?: Point): void;
}

/**
 * The generated module object
 */
export interface PuzzleModule extends MainModule {
  // Replace `any` args for Drawing.implement() and Frontend.implement()
  Drawing: {
    implement(drawing: DrawingImpl): DrawingWrapper;
    extend: MainModule["Drawing"]["extend"];
  };
}

export async function loadPuzzleModule(puzzleId: string): Promise<PuzzleModule> {
  // Point the shared emcc runtime to the desired puzzle.wasm
  const module = await createModule({
    locateFile: () => new URL(`../assets/js/${puzzleId}.wasm`, import.meta.url).href,
  });
  return module as PuzzleModule;
}
